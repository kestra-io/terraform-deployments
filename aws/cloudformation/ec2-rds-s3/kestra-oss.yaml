# Create stack:
# aws cloudformation create-stack \
#   --region eu-west-1 \
#   --stack-name kestra-marketplace-stack \
#   --template-body file://./kestra-oss.yaml \
#   --parameters \
#     ParameterKey=MasterUserPassword,ParameterValue=<db-password> \
#     ParameterKey=BasicAuthUser,ParameterValue=<kestra-admin-username> \
#     ParameterKey=BasicAuthPassword,ParameterValue=<kestra-admin-password> \
#     ParameterKey=BucketName,ParameterValue=<bucket-name> \
#     ParameterKey=AWSRegion,ParameterValue=eu-west-1 \
#     ParameterKey=VpcId,ParameterValue=<vpc-id> \
#     ParameterKey=SubnetIdEC2,ParameterValue=<subnet-for-ec2> \
#     ParameterKey=SubnetIdRDS1,ParameterValue=<subnet-for-rds-1> \
#     ParameterKey=SubnetIdRDS2,ParameterValue=<subnet-for-rds-2> \
#     ParameterKey=DBInstanceIdentifier,ParameterValue=kestra-db \
#     ParameterKey=DBName,ParameterValue=kestra \
#     ParameterKey=DBEngineVersion,ParameterValue=17.4 \
#     ParameterKey=DBInstanceClass,ParameterValue=db.t4g.micro \
#     ParameterKey=EC2InstanceType,ParameterValue=t3.medium \
#     ParameterKey=KeyPairName,ParameterValue=<your-keypair-name> \
#     ParameterKey=SSHLocation,ParameterValue=<your-ip>/32 \
#   --capabilities CAPABILITY_IAM
#
# Delete stack:
# aws cloudformation delete-stack \
#   --region eu-west-1 \
#   --stack-name kestra-marketplace-stack
#
# Prerequisites (manual setup required before running the stack)
# - An existing VPC
# - Existing subnets inside that VPC
# - Appropriate IAM permissions for the user running the command

AWSTemplateFormatVersion: "2010-09-09"
Description: PostgreSQL RDS, S3 bucket, and EC2 (with Docker) in eu-west-1

Parameters:
  MasterUsername:
    Type: String
    Default: kestra
    Description: The username for the PostgreSQL RDS database.
  MasterUserPassword:
    Type: String
    NoEcho: true
    Description: The password for the PostgreSQL RDS database master user. This value is hidden for security.
  BucketName:
    Type: String
    Description: The name of the S3 bucket that Kestra will use for storage. Must be globally unique.
  LatestAmiId:
    Type: String
    Description: The ID of the Ubuntu AMI used to launch the EC2 instance. Use an AMI with Docker preinstalled.
  AWSRegion:
    Type: String
    Default: eu-west-1
    Description: The AWS region where all resources (EC2, RDS, S3) will be deployed.
  BasicAuthUser:
    Type: String
    Default: admin@kestra.io
    Description: The username (email) used to log in to the Kestra UI. Must be a valid email address.
  BasicAuthPassword:
    Type: String
    NoEcho: true
    Description: The password for the Kestra UI basic authentication. Hidden for security.
  DBInstanceIdentifier:
    Type: String
    Default: kestra
    Description: The unique identifier for the RDS PostgreSQL instance.
  DBName:
    Type: String
    Default: kestra
    Description: The name of the PostgreSQL database created on the RDS instance.
  DBEngineVersion:
    Type: String
    Default: "17.4"
    Description: The PostgreSQL engine version used for the RDS instance.
  DBInstanceClass:
    Type: String
    Default: db.t4g.micro
    Description: The instance class for the PostgreSQL RDS instance (defines CPU and memory).
  VpcId:
    Type: String
    Description: The ID of the existing VPC where all resources will be deployed.
  SubnetIdEC2:
    Type: String
    Description: The ID of the subnet within the VPC where the EC2 instance will be launched.
  SubnetIdRDS1:
    Type: String
    Description: The first subnet ID used by the RDS Subnet Group for high availability.
  SubnetIdRDS2:
    Type: String
    Description: The second subnet ID used by the RDS Subnet Group for high availability.
  EC2InstanceType:
    Type: String
    Default: t3.medium
    Description: The instance type for the EC2 instance that hosts Kestra (defines CPU and memory).
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: The name of an existing EC2 Key Pair to enable SSH access to the instance.
  SSHLocation:
    Type: String
    Description: Set CIDR to x.x.x.x/32 to allow one specific IP address access, 0.0.0.0/0 to allow all IP addresses access, or another CIDR range.

Resources:
  # -------------------------
  # PostgreSQL RDS Instance
  # -------------------------
  PostgresDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier:
        Ref: DBInstanceIdentifier
      DBName:
        Ref: DBName
      Engine: postgres
      EngineVersion:
        Ref: DBEngineVersion
      MasterUsername:
        Ref: MasterUsername
      MasterUserPassword:
        Ref: MasterUserPassword
      AllocatedStorage: 20
      DBInstanceClass:
        Ref: DBInstanceClass
      PubliclyAccessible: false
      BackupRetentionPeriod: 0
      MultiAZ: false
      StorageType: gp2
      DeletionProtection: false
      DeleteAutomatedBackups: true
      AutoMinorVersionUpgrade: false
      VPCSecurityGroups:
        - Ref: RDSSecurityGroup
      DBSubnetGroupName:
        Ref: DBSubnetGroup

  # -------------------------
  # DB Subnet Group for RDS
  # -------------------------
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Use existing VPC subnets for RDS
      SubnetIds:
        - Ref: SubnetIdRDS1
        - Ref: SubnetIdRDS2
      Tags:
        - Key: Name
          Value: kestra-db-subnet-group

  # -------------------------
  # Security Group for RDS
  # -------------------------
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow EC2 to access RDS on port 5432
      VpcId:
        Ref: VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId:
            Ref: AppSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  # -------------------------
  # S3 Bucket
  # -------------------------
  StorageBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName:
        Ref: BucketName
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # -------------------------
  # EC2 Security Group
  # -------------------------
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Kestra UI, and RDS access within VPC
      VpcId:
        Ref: VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp:
            Ref: SSHLocation
          Description: SSH access
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
          Description: Kestra port UI
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  # -------------------------
  # EC2 Instance
  # -------------------------
  AppEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      KeyName:
        Ref: KeyPairName
      SubnetId:
        Ref: SubnetIdEC2
      IamInstanceProfile:
        Ref: EC2InstanceProfile
      InstanceType:
        Ref: EC2InstanceType
      SecurityGroupIds:
        - Ref: AppSecurityGroup
      ImageId:
        Ref: LatestAmiId
      UserData:
        Fn::Base64:
          Fn::Sub: |
            #!/bin/bash
            set -e
            cat <<EOF > /home/ubuntu/application-aws-ec2-marketplace.yaml
            datasources:
              postgres:
                url: jdbc:postgresql://${PostgresDB.Endpoint.Address}:5432/${DBName}
                driverClassName: org.postgresql.Driver
                username: ${MasterUsername}
                password: ${MasterUserPassword}
            kestra:
              server:
                basic-auth:
                  enabled: true
                  username: ${BasicAuthUser}
                  password: ${BasicAuthPassword}
              repository:
                type: postgres
              storage:
                type: s3
                s3:
                  region: ${AWSRegion}
                  bucket: ${StorageBucket}
              queue:
                type: postgres
              tasks:
                tmp-dir:
                  path: "/tmp/kestra-wd/tmp"
              url: "http://localhost:8080/"
            EOF
            echo "Config file written to /home/ubuntu/application-aws-ec2-marketplace.yaml" > /home/ubuntu/READY.txt
            docker run --pull=always --rm -d \
              -p 8080:8080 \
              --user=root \
              -e MICRONAUT_ENVIRONMENTS=aws-ec2-marketplace \
              -v /home/ubuntu/application-aws-ec2-marketplace.yaml:/etc/config/application-aws-ec2-marketplace.yaml \
              -v /var/run/docker.sock:/var/run/docker.sock \
              --name kestra \
              kestra/kestra:latest server standalone --config /etc/config/application-aws-ec2-marketplace.yaml
            echo "Kestra server started" > /home/ubuntu/READY.txt
  # -------------------------
  # IAM Role and Instance Profile
  # -------------------------
  EC2S3AccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: "/"
      Policies:
        - PolicyName: EC2S3AccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - Fn::GetAtt:
                      - StorageBucket
                      - Arn
                  - Fn::Sub: "${StorageBucket.Arn}/*"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - Ref: EC2S3AccessRole

